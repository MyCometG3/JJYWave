# JJYWave Tests

このディレクトリは JJYWave の自動テストに関するガイドと補足資料を提供します。  
テストは Xcode のテスト機構（XCTest）で実行し、ユニットテストと一部の統合テストを含みます。

- 対象プラットフォーム: macOS
- ビルド/テストは Xcode IDE からのみ実行（コマンドラインは対象外）

## 実行方法

Xcode で以下の手順を行います。

1) プロジェクトを開く: `JJYWave.xcodeproj`  
2) スキーム: JJYWave（既定）  
3) テストプラン: `JJYWaveTests.xctestplan`（同梱）  
4) 実行: ⌘U（または Product → Test）

推奨手順:  
- まず Clean Build Folder（⌘⇧K）→ Build（⌘B）  
- コンパイルエラーを解消してから ⌘U でテストを実行

## テスト構成

- JJYWaveTests/  
  - フレーム生成、スケジューリング、オーディオ生成の各レイヤを対象にしたテスト群
- 代表的な対象コード
  - App 層: `App/`（UI 連携は最小限の検証）
  - コア: `JJYKit/`
    - `JJYAudioGenerator.swift`（オーディオ生成の中核）
    - `JJYAudioGenerator+FrameBuilder.swift`（JJY 時刻コードのフレーム構築）
    - `JJYAudioGenerator+Configuration.swift`（設定・パラメータ管理）

注: ファイル名は代表例です。名称や配置はプロジェクトの最新状態に合わせて読み替えてください。

## テストカテゴリと観点

1) フレーム構築（Frame Builder）
- 目的: 指定日時に対して正しい 1 分フレームが構築されること
- 観点:
  - 各秒のシンボル種別が意図通り（0/1/マーカー）
  - BCD/インデックスの配置、サービスビット、うるう秒/うるう年フラグの取り扱い
  - マーカー秒の配置（分境界・所定インデックス）と整合性
- 代表的な検証:
  - 固定日時（UTC/ローカルいずれかに統一）でのゴールデンフレーム比較
  - うるう秒挿入/非挿入の両ケースでの整合性

2) スケジューリング（分境界・ドリフト）
- 目的: 1 秒単位・1 分単位のスケジュールが安定し、分境界の切り替えが適切であること
- 観点:
  - 分境界でのフレームローテーション
  - 内部タイマのジッタ/ドリフト許容範囲内での更新（許容値は実装に合わせる）
  - 実時間とフレーム進行の一貫性（モック/フェイク時刻源で検証）

3) オーディオ生成（Audio Generator）
- 目的: 指定周波数のサイン波が生成され、JJY 変調（AM のデューティ）が仕様に近いこと
- 観点:
  - 周波数精度（例: 相対誤差 ±50 ppm 程度を目安。装置設定・サンプルレートに依存）
  - バッファ長とサンプルレートの整合（duration × sampleRate ≒ bufferCount）
  - デューティ（低振幅区間）の所要長
    - 0: 約 0.8 s
    - 1: 約 0.5 s
    - マーカー: 約 0.2 s
  - 許容誤差の一例（参考値、実装に合わせて調整）
    - 時間長: ±1〜2 ms 程度
    - 振幅レベル: 相対比の整合（低振幅/通常振幅の二値が識別できること）
- 代表的な検証手法:
  - 生成バッファを解析し、振幅エンベロープから低振幅区間の開始/終了サンプルを推定
  - 1 秒あたりのゼロクロス/FFT を用いた周波数推定（許容誤差内か）

4) UI とエンジン状態の整合（軽量）
- 目的: 生成開始/停止、周波数切替時の状態同期
- 観点:
  - 生成中は 40/60 kHz の切替がブロックされる
  - Stop で確実に停止状態へ遷移
- 備考: UI は主に手動確認を推奨（自動化は最小限）

## ゴールデンデータと固定日時

- テストは再現性のため固定日時（例: 2024-01-01 00:00:00）を用いてフレームを検証
- うるう秒/サマータイムの有無はテストケースごとに明示
- 期待フレーム（ゴールデン）は、実装のフォーマッタ/ビルダとは独立したロジックで計算し、相互依存を避ける

## サンプル閾値（参考）

プロジェクト設定や実装により数値は変わり得ます。テスト側の許容値は、実際のサンプルレートや処理系の丸めに合わせて調整してください。

- サンプルレート: 96,000 Hz（既定の例）
- 時間誤差許容: ±1 ms（= 96 サンプル）〜 ±2 ms
- 周波数相対誤差: ±50 ppm（テストの安定性と実機差を考慮）

## よくある失敗と対処

- フレームが 60 秒分にならない/マーカー位置不一致
  - 分境界の扱い、59 秒目の扱い、マーカー秒の定義を確認
  - タイムゾーン/日付変換の境界（UTC vs ローカル）に注意
- デューティ時間の僅差で失敗
  - サンプル境界の丸めを考慮して許容値を広げる
  - エンベロープ検出のしきい値を見直す（振幅正規化/平滑化）
- 周波数推定が不安定
  - ウィンドウ長を整数秒にする、FFT の分解能/窓関数を見直す
  - ウォームアップ区間を除外する
- テストがローカル環境依存でフレーク
  - オーディオデバイス依存を排し、純粋関数に近い層を優先して検証
  - 実時間に依存する箇所はモック時刻源を介す

## 追加・変更のガイドライン

- 新規テストを追加する場合
  - `JJYWaveTests` ターゲットにファイルを追加
  - 必要に応じて `JJYWaveTests.xctestplan` にテストを組み込む
  - UI の文言変更がある場合は `Localizable.xcstrings` にエントリを追加し、両言語で確認
- 実装変更を伴う場合
  - ⌘B → ⌘U → ⌘R の順で「ビルド → 自動テスト → 手動検証」を徹底
  - 生成開始/停止のサイクルと周波数切替の両方向を必ず確認

## 手動検証（補助）

- アプリ起動（⌘R）→ Start/Stop の往復
- 周波数の切替（13.333 / 15.000 / 20.000 / 40.000 / 60.000 kHz）
- 40/60 kHz は生成停止後に切替可であることを確認
- ローカライズ（英/日）で UI が崩れないこと
- 音量は安全なレベルを厳守

## トラブルシューティング

- ビルド失敗
  - Xcode を最新化、Clean（⌘⇧K）後に再ビルド
  - ターゲットの割当・コード署名を確認
- 実行時/テスト時の失敗
  - Console.app でログを確認
  - オーディオ権限・他アプリの占有を確認
  - サンプルレート/出力デバイス設定（Audio MIDI 設定）を見直す

---
最終更新: このドキュメントはリポジトリの最新構成に随時追従します。テスト仕様に変更が入った場合は、ここも併せて更新してください。